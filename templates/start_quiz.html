<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Start Quiz</title>
    <link rel ="stylesheet" href="static/start_quiz.css"> 
</head>
<body onload="fetchStats()">
    <h1>Welcome to Trivia Paradise, {{ username }}!</h1>

    <!-- 1) User Stats -->
    <div id="userStatsArea">
        <h3>Your Stats</h3>
        <p id="highScoreText">High Score: --</p>
        <p id="totalGamesText">Total Games: --</p>
        <p id="avgScoreText">Average Score: --</p>
    </div>
    <hr>

    <!-- 2) Leaderboard -->
    <div id="leaderboardArea">
        <h3>Leaderboard</h3>
        <table id="leaderboardTable" border="1" cellpadding="5">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>High Score</th>
                </tr>
            </thead>
            <tbody id="leaderboardBody">
                <!-- We'll dynamically fill this with JS -->
            </tbody>
        </table>
    </div>
    <hr>

    <!-- 3) Start Quiz Button -->
    <button id="startBtn" onclick="startQuiz()">Start Quiz</button>

    <!-- 4) Quiz Area (hidden at first) -->
    <div id="quizModal">
        <div class="modal-content">
            <!-- Optional close button; you can remove it if you want the quiz to run without manual cancellation -->
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="quizArea">
                <h2>Time Left: <span id="timer">60</span> seconds</h2>
                <p id="questionContainer"></p>
                <button id="trueBtn" style="display: none;" onclick="submitAnswer('True')">True</button>
                <button id="falseBtn" style="display: none;" onclick="submitAnswer('False')">False</button>
            </div>
        </div>
    </div>

    <!-- 5) Results Area (hidden initially) -->
    <div id="resultArea" style="display: none;">
        <h2>Quiz Results</h2>
        <p id="scoreText"></p>
        <p id="correctText"></p>
        <p id="wrongText"></p>
    </div>

    <script>
        let timerId = null;
        let timeLeft = 60;

        // ---------------------------------
        //  Load user stats & leaderboard
        // ---------------------------------
        function fetchStats() {
            fetch('/get_stats')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error("Failed to get stats:", data.error);
                        return;
                    }

                    const userStats = data.user_stats;
                    document.getElementById('highScoreText').textContent = "High Score: " + userStats.high_score;
                    document.getElementById('totalGamesText').textContent = "Total Games: " + userStats.total_games;
                    document.getElementById('avgScoreText').textContent = "Average Score: " + userStats.avg_score;

                    const leaderboard = data.leaderboard;
                    const leaderboardBody = document.getElementById('leaderboardBody');
                    leaderboardBody.innerHTML = ''; // Clear old rows

                    leaderboard.forEach((row, idx) => {
                        const tr = document.createElement('tr');

                        const tdName = document.createElement('td');
                        tdName.textContent = row.username || "Unknown";

                        const tdScore = document.createElement('td');
                        tdScore.textContent = row.high_score;

                        tr.appendChild(tdName);
                        tr.appendChild(tdScore);

                        leaderboardBody.appendChild(tr);
                    });
                })
                .catch(err => console.error("Error fetching stats:", err));
        }

        // -----------------------
        //  Called when Start Quiz
        // -----------------------
        function startQuiz() {
            fetch('/start_quiz', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    console.log("Quiz started:", data);
                    // Hide the Start Quiz button and show the quiz modal
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('quizModal').style.display = 'block';

                    // Reset timer to 60 seconds and start countdown
                    timeLeft = 60;
                    document.getElementById('timer').textContent = timeLeft;
                    if (timerId) clearInterval(timerId);
                    timerId = setInterval(() => {
                        timeLeft--;
                        document.getElementById('timer').textContent = timeLeft;
                        if (timeLeft <= 0) {
                            finishQuiz();
                        }
                    }, 1000);

                    // Load the first question from the server
                    loadQuestion();
                })
                .catch(err => console.error("Error starting quiz:", err));
        }

        function closeModal() {
            // Stop timer if any
            if (timerId) clearInterval(timerId);
            document.getElementById('quizModal').style.display = 'none';
        }

        // -------------------------
        //  Load the current Q
        // -------------------------
        function loadQuestion() {
            fetch('/get_question')
                .then(res => res.json())
                .then(qdata => {
                    console.log("Got question:", qdata);

                    if (qdata.done) {
                        // If no more questions, finish quiz
                        finishQuiz();
                        return;
                    }

                    // Display question
                    const container = document.getElementById('questionContainer');
                    container.textContent = qdata.question;

                    // Store question_id in a data attribute
                    container.setAttribute('data-qid', qdata.question_id);

                    // Show T/F buttons
                    document.getElementById('trueBtn').style.display = 'inline';
                    document.getElementById('falseBtn').style.display = 'inline';
                })
                .catch(err => console.error("Error loading question:", err));
        }

        // -----------------------
        //  Submit user's answer
        // -----------------------
        function submitAnswer(answer) {
            const container = document.getElementById('questionContainer');
            const question_id = container.getAttribute('data-qid') || '';

            fetch('/submit_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question_id: question_id,
                    answer: answer
                })
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Submitted answer:", data);
                    // load next Q
                    loadQuestion();
                })
                .catch(err => console.error("Error submitting answer:", err));
        }

        // --------------------------------
        //  Finish quiz early or time's up
        // --------------------------------
        function finishQuiz() {
            if (timerId) clearInterval(timerId);
            fetch('/finish_quiz', { method: 'POST' })
                .then(res => res.json())
                .then(result => {
                    console.log("Quiz finished:", result);

                    document.getElementById('quizModal').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('scoreText').textContent = "Final Score: " + result.score;
                    document.getElementById('correctText').textContent = "Correct: " + result.correct_count;
                    document.getElementById('wrongText').textContent = "Wrong: " + result.wrong_count;

                    fetchStats();

                    document.getElementById('startBtn').style.display = 'inline';
                })
                .catch(err => console.error("Error finishing quiz:", err));
        }
    </script>
</body>
</html>
