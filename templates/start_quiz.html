<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Start Quiz</title>
</head>
<body>
    <h1>Welcome to Trivia Paradise!</h1>
    <!-- Button to start the quiz -->
    <button id="startBtn" onclick="startQuiz()">Start Quiz</button>

    <!-- Quiz Area (hidden at first) -->
    <div id="quizArea" style="display: none;">
        <h2>Time Left: <span id="timer">60</span> seconds</h2>
        <p id="questionContainer"></p>
        <button id="trueBtn" style="display: none;" onclick="submitAnswer('True')">True</button>
        <button id="falseBtn" style="display: none;" onclick="submitAnswer('False')">False</button>
    </div>

    <!-- Results Area (hidden initially) -->
    <div id="resultArea" style="display: none;">
        <h2>Quiz Results</h2>
        <p id="scoreText"></p>
        <p id="correctText"></p>
        <p id="wrongText"></p>
        <br>
        <a href="/dashboard">Go to Dashboard</a>
    </div>

    <script>
        let timerId = null;
        let timeLeft = 60;

        // Called when "Start Quiz" is clicked.
        function startQuiz() {
            fetch('/start_quiz', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    console.log("Quiz started:", data);

                    // Hide the start button, show the quiz area
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('quizArea').style.display = 'block';
                    document.getElementById('resultArea').style.display = 'none';

                    // Reset timer to 60 seconds and start counting down
                    timeLeft = 60;
                    document.getElementById('timer').textContent = timeLeft;
                    if (timerId) clearInterval(timerId);

                    timerId = setInterval(() => {
                        timeLeft--;
                        document.getElementById('timer').textContent = timeLeft;
                        if (timeLeft <= 0) {
                            finishQuiz();
                        }
                    }, 1000);

                    // Load the first question from the server
                    loadQuestion();
                })
                .catch(err => console.error("Error starting quiz:", err));
        }

        // Asks server for the "current" question
        function loadQuestion() {
            fetch('/get_question')
                .then(res => res.json())
                .then(qdata => {
                    console.log("Got question:", qdata);

                    if (qdata.done) {
                        // If we're done (no more questions), finish
                        finishQuiz();
                        return;
                    }

                    // Display the question
                    const container = document.getElementById('questionContainer');
                    container.textContent = qdata.question;

                    // Store the question_id in a data attribute for reference
                    container.setAttribute('data-qid', qdata.question_id);

                    // Show the True/False buttons
                    document.getElementById('trueBtn').style.display = 'inline';
                    document.getElementById('falseBtn').style.display = 'inline';
                })
                .catch(err => console.error("Error loading question:", err));
        }

        // Submit answer to the server
        function submitAnswer(answer) {
            const container = document.getElementById('questionContainer');
            const question_id = container.getAttribute('data-qid') || '';

            fetch('/submit_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question_id: question_id,
                    answer: answer
                })
            })
                .then(res => res.json())
                .then(data => {
                    console.log("Submitted answer:", data);
                    // Now load the next question
                    loadQuestion();
                })
                .catch(err => console.error("Error submitting answer:", err));
        }

        // Finish quiz early or when time runs out
        function finishQuiz() {
            // Stop timer
            if (timerId) clearInterval(timerId);

            fetch('/finish_quiz', { method: 'POST' })
                .then(res => res.json())
                .then(result => {
                    console.log("Quiz finished:", result);

                    // Hide quiz, show results
                    document.getElementById('quizArea').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';

                    document.getElementById('scoreText').textContent = "Final Score: " + result.score;
                    document.getElementById('correctText').textContent = "Correct: " + result.correct_count;
                    document.getElementById('wrongText').textContent = "Wrong: " + result.wrong_count;
                })
                .catch(err => console.error("Error finishing quiz:", err));
        }
    </script>
</body>
</html>
